{"ast":null,"code":"import { cacheCookieAccess, COOKIE_ACCESS_DELAY } from './cookie';\nimport { monitor } from './internalMonitoring';\nimport { Observable } from './observable';\nimport { tryOldCookiesMigration } from './oldCookiesMigration';\nimport * as utils from './utils';\nexport var SESSION_COOKIE_NAME = '_dd_s';\nexport var SESSION_EXPIRATION_DELAY = 15 * utils.ONE_MINUTE;\nexport var SESSION_TIME_OUT_DELAY = 4 * utils.ONE_HOUR;\nexport var VISIBILITY_CHECK_DELAY = utils.ONE_MINUTE;\n/**\n * Limit access to cookie to avoid performance issues\n */\n\nexport function startSessionManagement(productKey, computeSessionState) {\n  var sessionCookie = cacheCookieAccess(SESSION_COOKIE_NAME);\n  tryOldCookiesMigration(sessionCookie);\n  var renewObservable = new Observable();\n  var currentSessionId = retrieveActiveSession(sessionCookie).id;\n  var expandOrRenewSession = utils.throttle(function () {\n    var session = retrieveActiveSession(sessionCookie);\n\n    var _a = computeSessionState(session[productKey]),\n        trackingType = _a.trackingType,\n        isTracked = _a.isTracked;\n\n    session[productKey] = trackingType;\n\n    if (isTracked && !session.id) {\n      session.id = utils.generateUUID();\n      session.created = String(Date.now());\n    } // save changes and expand session duration\n\n\n    persistSession(session, sessionCookie); // If the session id has changed, notify that the session has been renewed\n\n    if (isTracked && currentSessionId !== session.id) {\n      currentSessionId = session.id;\n      renewObservable.notify();\n    }\n  }, COOKIE_ACCESS_DELAY).throttled;\n\n  var expandSession = function () {\n    var session = retrieveActiveSession(sessionCookie);\n    persistSession(session, sessionCookie);\n  };\n\n  expandOrRenewSession();\n  trackActivity(expandOrRenewSession);\n  trackVisibility(expandSession);\n  return {\n    getId: function () {\n      return retrieveActiveSession(sessionCookie).id;\n    },\n    getTrackingType: function () {\n      return retrieveActiveSession(sessionCookie)[productKey];\n    },\n    renewObservable: renewObservable\n  };\n}\nvar SESSION_ENTRY_REGEXP = /^([a-z]+)=([a-z0-9-]+)$/;\nvar SESSION_ENTRY_SEPARATOR = '&';\nexport function isValidSessionString(sessionString) {\n  return sessionString !== undefined && (sessionString.indexOf(SESSION_ENTRY_SEPARATOR) !== -1 || SESSION_ENTRY_REGEXP.test(sessionString));\n}\n\nfunction retrieveActiveSession(sessionCookie) {\n  var session = retrieveSession(sessionCookie);\n\n  if (isActiveSession(session)) {\n    return session;\n  }\n\n  clearSession(sessionCookie);\n  return {};\n}\n\nfunction isActiveSession(session) {\n  // created and expire can be undefined for versions which was not storing them\n  // these checks could be removed when older versions will not be available/live anymore\n  return (session.created === undefined || Date.now() - Number(session.created) < SESSION_TIME_OUT_DELAY) && (session.expire === undefined || Date.now() < Number(session.expire));\n}\n\nfunction retrieveSession(sessionCookie) {\n  var sessionString = sessionCookie.get();\n  var session = {};\n\n  if (isValidSessionString(sessionString)) {\n    sessionString.split(SESSION_ENTRY_SEPARATOR).forEach(function (entry) {\n      var matches = SESSION_ENTRY_REGEXP.exec(entry);\n\n      if (matches !== null) {\n        var key = matches[1],\n            value = matches[2];\n        session[key] = value;\n      }\n    });\n  }\n\n  return session;\n}\n\nexport function persistSession(session, cookie) {\n  if (utils.isEmptyObject(session)) {\n    clearSession(cookie);\n    return;\n  }\n\n  session.expire = String(Date.now() + SESSION_EXPIRATION_DELAY);\n  var cookieString = utils.objectEntries(session).map(function (_a) {\n    var key = _a[0],\n        value = _a[1];\n    return key + \"=\" + value;\n  }).join(SESSION_ENTRY_SEPARATOR);\n  cookie.set(cookieString, SESSION_EXPIRATION_DELAY);\n}\n\nfunction clearSession(cookie) {\n  cookie.set('', 0);\n}\n\nexport function stopSessionManagement() {\n  stopCallbacks.forEach(function (e) {\n    return e();\n  });\n  stopCallbacks = [];\n}\nvar stopCallbacks = [];\nexport function trackActivity(expandOrRenewSession) {\n  var doExpandOrRenewSession = monitor(expandOrRenewSession);\n  var options = {\n    capture: true,\n    passive: true\n  };\n  [utils.DOM_EVENT.CLICK, utils.DOM_EVENT.TOUCH_START, utils.DOM_EVENT.KEY_DOWN, utils.DOM_EVENT.SCROLL].forEach(function (event) {\n    document.addEventListener(event, doExpandOrRenewSession, options);\n    stopCallbacks.push(function () {\n      return document.removeEventListener(event, doExpandOrRenewSession, options);\n    });\n  });\n}\n\nfunction trackVisibility(expandSession) {\n  var expandSessionWhenVisible = monitor(function () {\n    if (document.visibilityState === 'visible') {\n      expandSession();\n    }\n  });\n  var visibilityCheckInterval = window.setInterval(expandSessionWhenVisible, VISIBILITY_CHECK_DELAY);\n  document.addEventListener(utils.DOM_EVENT.VISIBILITY_CHANGE, expandSessionWhenVisible);\n  stopCallbacks.push(function () {\n    clearInterval(visibilityCheckInterval);\n    document.removeEventListener(utils.DOM_EVENT.VISIBILITY_CHANGE, expandSessionWhenVisible);\n  });\n}","map":{"version":3,"sources":["../src/sessionManagement.ts"],"names":[],"mappings":"AAAA,SAAS,iBAAT,EAA4B,mBAA5B,QAAoE,UAApE;AACA,SAAS,OAAT,QAAwB,sBAAxB;AACA,SAAS,UAAT,QAA2B,cAA3B;AACA,SAAS,sBAAT,QAAuC,uBAAvC;AACA,OAAO,KAAK,KAAZ,MAAuB,SAAvB;AAEA,OAAO,IAAM,mBAAmB,GAAG,OAA5B;AACP,OAAO,IAAM,wBAAwB,GAAG,KAAK,KAAK,CAAC,UAA5C;AACP,OAAO,IAAM,sBAAsB,GAAG,IAAI,KAAK,CAAC,QAAzC;AACP,OAAO,IAAM,sBAAsB,GAAG,KAAK,CAAC,UAArC;AAeP;;;;AAGA,OAAM,SAAU,sBAAV,CACJ,UADI,EAEJ,mBAFI,EAEiG;AAErG,MAAM,aAAa,GAAG,iBAAiB,CAAC,mBAAD,CAAvC;AACA,EAAA,sBAAsB,CAAC,aAAD,CAAtB;AACA,MAAM,eAAe,GAAG,IAAI,UAAJ,EAAxB;AACA,MAAI,gBAAgB,GAAG,qBAAqB,CAAC,aAAD,CAArB,CAAqC,EAA5D;AAEQ,MAAA,oBAAA,GAAA,KAAA,CAAA,QAAA,CAAA,YAAA;;;;;;;;;;;;KAAA,C;;;2CAAA,C;;;;;;GAAA,E,mBAAA,EAA+B,SAA/B;;AAkBR,MAAM,aAAa,GAAG,YAAA;AACpB,QAAM,OAAO,GAAG,qBAAqB,CAAC,aAAD,CAArC;AACA,IAAA,cAAc,CAAC,OAAD,EAAU,aAAV,CAAd;AACD,GAHD;;AAKA,EAAA,oBAAoB;AACpB,EAAA,aAAa,CAAC,oBAAD,CAAb;AACA,EAAA,eAAe,CAAC,aAAD,CAAf;AAEA,SAAO;AACL,IAAA,KAAK,EAAA,YAAA;AACH,aAAO,qBAAqB,CAAC,aAAD,CAArB,CAAqC,EAA5C;AACD,KAHI;AAIL,IAAA,eAAe,EAAf,YAAA;AACE,aAAO,qBAAqB,CAAC,aAAD,CAArB,CAAqC,UAArC,CAAP;AACD,KANI;AAOL,IAAA,eAAe,EAAA;AAPV,GAAP;AASD;AAED,IAAM,oBAAoB,GAAG,yBAA7B;AAEA,IAAM,uBAAuB,GAAG,GAAhC;AAEA,OAAM,SAAU,oBAAV,CAA+B,aAA/B,EAAgE;AACpE,SACE,aAAa,KAAK,SAAlB,KACC,aAAa,CAAC,OAAd,CAAsB,uBAAtB,MAAmD,CAAC,CAApD,IAAyD,oBAAoB,CAAC,IAArB,CAA0B,aAA1B,CAD1D,CADF;AAID;;AAED,SAAS,qBAAT,CAA+B,aAA/B,EAAyD;AACvD,MAAM,OAAO,GAAG,eAAe,CAAC,aAAD,CAA/B;;AACA,MAAI,eAAe,CAAC,OAAD,CAAnB,EAA8B;AAC5B,WAAO,OAAP;AACD;;AACD,EAAA,YAAY,CAAC,aAAD,CAAZ;AACA,SAAO,EAAP;AACD;;AAED,SAAS,eAAT,CAAyB,OAAzB,EAA8C;AAC5C;AACA;AACA,SACE,CAAC,OAAO,CAAC,OAAR,KAAoB,SAApB,IAAiC,IAAI,CAAC,GAAL,KAAa,MAAM,CAAC,OAAO,CAAC,OAAT,CAAnB,GAAuC,sBAAzE,MACC,OAAO,CAAC,MAAR,KAAmB,SAAnB,IAAgC,IAAI,CAAC,GAAL,KAAa,MAAM,CAAC,OAAO,CAAC,MAAT,CADpD,CADF;AAID;;AAED,SAAS,eAAT,CAAyB,aAAzB,EAAmD;AACjD,MAAM,aAAa,GAAG,aAAa,CAAC,GAAd,EAAtB;AACA,MAAM,OAAO,GAAiB,EAA9B;;AACA,MAAI,oBAAoB,CAAC,aAAD,CAAxB,EAAyC;AACvC,IAAA,aAAa,CAAC,KAAd,CAAoB,uBAApB,EAA6C,OAA7C,CAAqD,UAAC,KAAD,EAAM;AACzD,UAAM,OAAO,GAAG,oBAAoB,CAAC,IAArB,CAA0B,KAA1B,CAAhB;;AACA,UAAI,OAAO,KAAK,IAAhB,EAAsB;AACX,YAAA,GAAA,GAAA,OAAA,CAAA,CAAA,CAAA;AAAA,YAAK,KAAA,GAAA,OAAA,CAAA,CAAA,CAAL;AACT,QAAA,OAAO,CAAC,GAAD,CAAP,GAAe,KAAf;AACD;AACF,KAND;AAOD;;AACD,SAAO,OAAP;AACD;;AAED,OAAM,SAAU,cAAV,CAAyB,OAAzB,EAAgD,MAAhD,EAAmE;AACvE,MAAI,KAAK,CAAC,aAAN,CAAoB,OAApB,CAAJ,EAAkC;AAChC,IAAA,YAAY,CAAC,MAAD,CAAZ;AACA;AACD;;AACD,EAAA,OAAO,CAAC,MAAR,GAAiB,MAAM,CAAC,IAAI,CAAC,GAAL,KAAa,wBAAd,CAAvB;AACA,MAAM,YAAY,GAAG,KAAK,CACvB,aADkB,CACJ,OADI,EAElB,GAFkB,CAEd,UAAC,EAAD,EAAa;QAAX,GAAA,GAAA,EAAA,CAAA,CAAA,C;QAAK,KAAA,GAAA,EAAA,CAAA,CAAA,C;AAAW,WAAG,GAAG,GAAA,GAAH,GAAO,KAAV;AAAiB,GAFrB,EAGlB,IAHkB,CAGb,uBAHa,CAArB;AAIA,EAAA,MAAM,CAAC,GAAP,CAAW,YAAX,EAAyB,wBAAzB;AACD;;AAED,SAAS,YAAT,CAAsB,MAAtB,EAAyC;AACvC,EAAA,MAAM,CAAC,GAAP,CAAW,EAAX,EAAe,CAAf;AACD;;AAED,OAAM,SAAU,qBAAV,GAA+B;AACnC,EAAA,aAAa,CAAC,OAAd,CAAsB,UAAC,CAAD,EAAE;AAAK,WAAA,CAAA,EAAA;AAAG,GAAhC;AACA,EAAA,aAAa,GAAG,EAAhB;AACD;AAED,IAAI,aAAa,GAAsB,EAAvC;AAEA,OAAM,SAAU,aAAV,CAAwB,oBAAxB,EAAwD;AAC5D,MAAM,sBAAsB,GAAG,OAAO,CAAC,oBAAD,CAAtC;AACA,MAAM,OAAO,GAAG;AAAE,IAAA,OAAO,EAAE,IAAX;AAAiB,IAAA,OAAO,EAAE;AAA1B,GAAhB;AACC,GAAC,KAAK,CAAC,SAAN,CAAgB,KAAjB,EAAwB,KAAK,CAAC,SAAN,CAAgB,WAAxC,EAAqD,KAAK,CAAC,SAAN,CAAgB,QAArE,EAA+E,KAAK,CAAC,SAAN,CAAgB,MAA/F,EAAuG,OAAvG,CACC,UAAC,KAAD,EAAc;AACZ,IAAA,QAAQ,CAAC,gBAAT,CAA0B,KAA1B,EAAiC,sBAAjC,EAAyD,OAAzD;AACA,IAAA,aAAa,CAAC,IAAd,CAAmB,YAAA;AAAM,aAAA,QAAQ,CAAC,mBAAT,CAA6B,KAA7B,EAAoC,sBAApC,EAAA,OAAA,CAAA;AAAoE,KAA7F;AACD,GAJF;AAMF;;AAED,SAAS,eAAT,CAAyB,aAAzB,EAAkD;AAChD,MAAM,wBAAwB,GAAG,OAAO,CAAC,YAAA;AACvC,QAAI,QAAQ,CAAC,eAAT,KAA6B,SAAjC,EAA4C;AAC1C,MAAA,aAAa;AACd;AACF,GAJuC,CAAxC;AAMA,MAAM,uBAAuB,GAAG,MAAM,CAAC,WAAP,CAAmB,wBAAnB,EAA6C,sBAA7C,CAAhC;AACA,EAAA,QAAQ,CAAC,gBAAT,CAA0B,KAAK,CAAC,SAAN,CAAgB,iBAA1C,EAA6D,wBAA7D;AAEA,EAAA,aAAa,CAAC,IAAd,CAAmB,YAAA;AACjB,IAAA,aAAa,CAAC,uBAAD,CAAb;AACA,IAAA,QAAQ,CAAC,mBAAT,CAA6B,KAAK,CAAC,SAAN,CAAgB,iBAA7C,EAAgE,wBAAhE;AACD,GAHD;AAID","sourceRoot":"","sourcesContent":["import { cacheCookieAccess, COOKIE_ACCESS_DELAY } from './cookie';\nimport { monitor } from './internalMonitoring';\nimport { Observable } from './observable';\nimport { tryOldCookiesMigration } from './oldCookiesMigration';\nimport * as utils from './utils';\nexport var SESSION_COOKIE_NAME = '_dd_s';\nexport var SESSION_EXPIRATION_DELAY = 15 * utils.ONE_MINUTE;\nexport var SESSION_TIME_OUT_DELAY = 4 * utils.ONE_HOUR;\nexport var VISIBILITY_CHECK_DELAY = utils.ONE_MINUTE;\n/**\n * Limit access to cookie to avoid performance issues\n */\nexport function startSessionManagement(productKey, computeSessionState) {\n    var sessionCookie = cacheCookieAccess(SESSION_COOKIE_NAME);\n    tryOldCookiesMigration(sessionCookie);\n    var renewObservable = new Observable();\n    var currentSessionId = retrieveActiveSession(sessionCookie).id;\n    var expandOrRenewSession = utils.throttle(function () {\n        var session = retrieveActiveSession(sessionCookie);\n        var _a = computeSessionState(session[productKey]), trackingType = _a.trackingType, isTracked = _a.isTracked;\n        session[productKey] = trackingType;\n        if (isTracked && !session.id) {\n            session.id = utils.generateUUID();\n            session.created = String(Date.now());\n        }\n        // save changes and expand session duration\n        persistSession(session, sessionCookie);\n        // If the session id has changed, notify that the session has been renewed\n        if (isTracked && currentSessionId !== session.id) {\n            currentSessionId = session.id;\n            renewObservable.notify();\n        }\n    }, COOKIE_ACCESS_DELAY).throttled;\n    var expandSession = function () {\n        var session = retrieveActiveSession(sessionCookie);\n        persistSession(session, sessionCookie);\n    };\n    expandOrRenewSession();\n    trackActivity(expandOrRenewSession);\n    trackVisibility(expandSession);\n    return {\n        getId: function () {\n            return retrieveActiveSession(sessionCookie).id;\n        },\n        getTrackingType: function () {\n            return retrieveActiveSession(sessionCookie)[productKey];\n        },\n        renewObservable: renewObservable,\n    };\n}\nvar SESSION_ENTRY_REGEXP = /^([a-z]+)=([a-z0-9-]+)$/;\nvar SESSION_ENTRY_SEPARATOR = '&';\nexport function isValidSessionString(sessionString) {\n    return (sessionString !== undefined &&\n        (sessionString.indexOf(SESSION_ENTRY_SEPARATOR) !== -1 || SESSION_ENTRY_REGEXP.test(sessionString)));\n}\nfunction retrieveActiveSession(sessionCookie) {\n    var session = retrieveSession(sessionCookie);\n    if (isActiveSession(session)) {\n        return session;\n    }\n    clearSession(sessionCookie);\n    return {};\n}\nfunction isActiveSession(session) {\n    // created and expire can be undefined for versions which was not storing them\n    // these checks could be removed when older versions will not be available/live anymore\n    return ((session.created === undefined || Date.now() - Number(session.created) < SESSION_TIME_OUT_DELAY) &&\n        (session.expire === undefined || Date.now() < Number(session.expire)));\n}\nfunction retrieveSession(sessionCookie) {\n    var sessionString = sessionCookie.get();\n    var session = {};\n    if (isValidSessionString(sessionString)) {\n        sessionString.split(SESSION_ENTRY_SEPARATOR).forEach(function (entry) {\n            var matches = SESSION_ENTRY_REGEXP.exec(entry);\n            if (matches !== null) {\n                var key = matches[1], value = matches[2];\n                session[key] = value;\n            }\n        });\n    }\n    return session;\n}\nexport function persistSession(session, cookie) {\n    if (utils.isEmptyObject(session)) {\n        clearSession(cookie);\n        return;\n    }\n    session.expire = String(Date.now() + SESSION_EXPIRATION_DELAY);\n    var cookieString = utils\n        .objectEntries(session)\n        .map(function (_a) {\n        var key = _a[0], value = _a[1];\n        return key + \"=\" + value;\n    })\n        .join(SESSION_ENTRY_SEPARATOR);\n    cookie.set(cookieString, SESSION_EXPIRATION_DELAY);\n}\nfunction clearSession(cookie) {\n    cookie.set('', 0);\n}\nexport function stopSessionManagement() {\n    stopCallbacks.forEach(function (e) { return e(); });\n    stopCallbacks = [];\n}\nvar stopCallbacks = [];\nexport function trackActivity(expandOrRenewSession) {\n    var doExpandOrRenewSession = monitor(expandOrRenewSession);\n    var options = { capture: true, passive: true };\n    [utils.DOM_EVENT.CLICK, utils.DOM_EVENT.TOUCH_START, utils.DOM_EVENT.KEY_DOWN, utils.DOM_EVENT.SCROLL].forEach(function (event) {\n        document.addEventListener(event, doExpandOrRenewSession, options);\n        stopCallbacks.push(function () { return document.removeEventListener(event, doExpandOrRenewSession, options); });\n    });\n}\nfunction trackVisibility(expandSession) {\n    var expandSessionWhenVisible = monitor(function () {\n        if (document.visibilityState === 'visible') {\n            expandSession();\n        }\n    });\n    var visibilityCheckInterval = window.setInterval(expandSessionWhenVisible, VISIBILITY_CHECK_DELAY);\n    document.addEventListener(utils.DOM_EVENT.VISIBILITY_CHANGE, expandSessionWhenVisible);\n    stopCallbacks.push(function () {\n        clearInterval(visibilityCheckInterval);\n        document.removeEventListener(utils.DOM_EVENT.VISIBILITY_CHANGE, expandSessionWhenVisible);\n    });\n}\n//# sourceMappingURL=sessionManagement.js.map"]},"metadata":{},"sourceType":"module"}